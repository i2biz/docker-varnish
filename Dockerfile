FROM centos:centos7
MAINTAINER Przemyslaw Ozgo linux@ozgo.info, Marcin Ryzycki marcin@m12.io

RUN yum update -y && \
  yum install -y epel-release && \
  yum install -y varnish && \
  yum install -y libmhash-devel && \
  yum clean all

COPY start.sh entrypoint.sh /

ENV VARNISH_CACHE_SIZE=64m \
    VARNISH_VARNISHD_PARAMS="-p default_ttl=3600 -p default_grace=3600" \
    # This is default config for varnish4
    VARNISH_ACL_CONFIG="IwojIFRoaXMgaXMgYW4gZXhhbXBsZSBWQ0wgZmlsZSBmb3IgVmFybmlzaC4KIwojIEl0IGRvZXMgbm90IGRvIGFueXRoaW5nIGJ5IGRlZmF1bHQsIGRlbGVnYXRpbmcgY29udHJvbCB0byB0aGUKIyBidWlsdGluIFZDTC4gVGhlIGJ1aWx0aW4gVkNMIGlzIGNhbGxlZCB3aGVuIHRoZXJlIGlzIG5vIGV4cGxpY2l0CiMgcmV0dXJuIHN0YXRlbWVudC4KIwojIFNlZSB0aGUgVkNMIGNoYXB0ZXJzIGluIHRoZSBVc2VycyBHdWlkZSBhdCBodHRwczovL3d3dy52YXJuaXNoLWNhY2hlLm9yZy9kb2NzLwojIGFuZCBodHRwOi8vdmFybmlzaC1jYWNoZS5vcmcvdHJhYy93aWtpL1ZDTEV4YW1wbGVzIGZvciBtb3JlIGV4YW1wbGVzLgoKIyBNYXJrZXIgdG8gdGVsbCB0aGUgVkNMIGNvbXBpbGVyIHRoYXQgdGhpcyBWQ0wgaGFzIGJlZW4gYWRhcHRlZCB0byB0aGUKIyBuZXcgNC4wIGZvcm1hdC4KdmNsIDQuMDsKCiMgRGVmYXVsdCBiYWNrZW5kIGRlZmluaXRpb24uIFNldCB0aGlzIHRvIHBvaW50IHRvIHlvdXIgY29udGVudCBzZXJ2ZXIuCmJhY2tlbmQgZGVmYXVsdCB7CiAgICAuaG9zdCA9ICIxMjcuMC4wLjEiOwogICAgLnBvcnQgPSAiODA4MCI7Cn0KCnN1YiB2Y2xfcmVjdiB7CiAgICAjIEhhcHBlbnMgYmVmb3JlIHdlIGNoZWNrIGlmIHdlIGhhdmUgdGhpcyBpbiBjYWNoZSBhbHJlYWR5LgogICAgIwogICAgIyBUeXBpY2FsbHkgeW91IGNsZWFuIHVwIHRoZSByZXF1ZXN0IGhlcmUsIHJlbW92aW5nIGNvb2tpZXMgeW91IGRvbid0IG5lZWQsCiAgICAjIHJld3JpdGluZyB0aGUgcmVxdWVzdCwgZXRjLgp9CgpzdWIgdmNsX2JhY2tlbmRfcmVzcG9uc2UgewogICAgIyBIYXBwZW5zIGFmdGVyIHdlIGhhdmUgcmVhZCB0aGUgcmVzcG9uc2UgaGVhZGVycyBmcm9tIHRoZSBiYWNrZW5kLgogICAgIwogICAgIyBIZXJlIHlvdSBjbGVhbiB0aGUgcmVzcG9uc2UgaGVhZGVycywgcmVtb3Zpbmcgc2lsbHkgU2V0LUNvb2tpZSBoZWFkZXJzCiAgICAjIGFuZCBvdGhlciBtaXN0YWtlcyB5b3VyIGJhY2tlbmQgZG9lcy4KfQoKc3ViIHZjbF9kZWxpdmVyIHsKICAgICMgSGFwcGVucyB3aGVuIHdlIGhhdmUgYWxsIHRoZSBwaWVjZXMgd2UgbmVlZCwgYW5kIGFyZSBhYm91dCB0byBzZW5kIHRoZQogICAgIyByZXNwb25zZSB0byB0aGUgY2xpZW50LgogICAgIwogICAgIyBZb3UgY2FuIGRvIGFjY291bnRpbmcgb3IgbW9kaWZ5aW5nIHRoZSBmaW5hbCBvYmplY3QgaGVyZS4KfQo="
CMD ["/start.sh"]
ENTRYPOINT ["/entrypoint.sh"]
EXPOSE 80
